import { memo, useState, useRef, useEffect } from 'react';\nimport { useResourceOptimization } from '../lib/resourceOptimizer';\n\ninterface OptimizedImageProps {\n  src: string;\n  alt: string;\n  width?: number;\n  height?: number;\n  className?: string;\n  loading?: 'lazy' | 'eager';\n  sizes?: string;\n  priority?: boolean; // High priority images (LCP candidates)\n}\n\nfunction OptimizedImage({\n  src,\n  alt,\n  width,\n  height,\n  className = '',\n  loading = 'lazy',\n  sizes = '100vw',\n  priority = false,\n}: OptimizedImageProps) {\n  const [isLoaded, setIsLoaded] = useState(false);\n  const [isError, setIsError] = useState(false);\n  const imgRef = useRef<HTMLImageElement>(null);\n  const { preserveAspectRatio } = useResourceOptimization();\n\n  useEffect(() => {\n    const img = imgRef.current;\n    if (!img) return;\n\n    // Preserve aspect ratio to prevent CLS\n    if (width && height) {\n      preserveAspectRatio(img, width / height);\n    }\n\n    // Handle load events\n    const handleLoad = () => {\n      setIsLoaded(true);\n      setIsError(false);\n    };\n\n    const handleError = () => {\n      setIsError(true);\n      setIsLoaded(false);\n    };\n\n    img.addEventListener('load', handleLoad);\n    img.addEventListener('error', handleError);\n\n    return () => {\n      img.removeEventListener('load', handleLoad);\n      img.removeEventListener('error', handleError);\n    };\n  }, [width, height, preserveAspectRatio]);\n\n  // Generate responsive image sources\n  const generateSrcSet = (baseSrc: string): string => {\n    const extensions = ['.png', '.jpg', '.jpeg', '.webp', '.avif'];\n    const hasExtension = extensions.some(ext => baseSrc.includes(ext));\n    \n    if (!hasExtension) return baseSrc;\n    \n    const baseWithoutExt = baseSrc.replace(/\\.[^/.]+$/, '');\n    const ext = baseSrc.match(/\\.[^/.]+$/)?.[0] || '';\n    \n    // Generate multiple sizes for responsive images\n    const sizes = [320, 640, 768, 1024, 1280, 1536];\n    return sizes\n      .map(size => `${baseWithoutExt}_${size}${ext} ${size}w`)\n      .join(', ');\n  };\n\n  const imgStyle: React.CSSProperties = {\n    opacity: isLoaded ? 1 : 0,\n    transition: 'opacity 0.3s ease-in-out',\n    ...(width && height ? { aspectRatio: `${width}/${height}` } : {}),\n  };\n\n  const containerStyle: React.CSSProperties = {\n    position: 'relative',\n    overflow: 'hidden',\n    ...(width && height ? { width, height } : {}),\n  };\n\n  return (\n    <div className={`optimized-image-container ${className}`} style={containerStyle}>\n      {/* Loading skeleton to prevent CLS */}\n      {!isLoaded && !isError && (\n        <div\n          className=\"absolute inset-0 bg-gradient-to-br from-gray-100 to-gray-200 animate-pulse\"\n          style={{\n            backgroundSize: '200% 100%',\n            animation: 'shimmer 1.5s infinite',\n          }}\n        />\n      )}\n      \n      {/* Error state */}\n      {isError && (\n        <div className=\"absolute inset-0 flex items-center justify-center bg-gray-100 text-gray-400\">\n          <svg\n            className=\"w-8 h-8\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n            />\n          </svg>\n        </div>\n      )}\n      \n      {/* Actual image */}\n      <img\n        ref={imgRef}\n        src={src}\n        alt={alt}\n        srcSet={generateSrcSet(src)}\n        sizes={sizes}\n        loading={priority ? 'eager' : loading}\n        decoding=\"async\"\n        style={imgStyle}\n        className={`w-full h-full object-cover ${isLoaded ? 'loaded' : ''}`}\n        width={width}\n        height={height}\n      />\n      \n      <style jsx>{`\n        @keyframes shimmer {\n          0% {\n            background-position: -200% 0;\n          }\n          100% {\n            background-position: 200% 0;\n          }\n        }\n      `}</style>\n    </div>\n  );\n}\n\nexport default memo(OptimizedImage);
